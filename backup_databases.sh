#!/bin/bash

# ========================================
# Ù†Ø¸Ø§Ù… Ø§Ù„Ù†Ø³Ø® Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠ Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ
# Ù„Ù†Ø¸Ø§Ù… Alabasi Ø§Ù„Ù…Ø­Ø§Ø³Ø¨ÙŠ
# ========================================

# Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª
DB_USER="u306850950_alabasi1"
DB_PASS="Alabasi@2025"
BACKUP_DIR="/home/u306850950/backups"
DATE=$(date +"%Y%m%d_%H%M%S")
RETENTION_DAYS=30

# Ø¥Ù†Ø´Ø§Ø¡ Ù…Ø¬Ù„Ø¯ Ø§Ù„Ù†Ø³Ø® Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠØ© Ø¥Ø°Ø§ Ù„Ù… ÙŠÙƒÙ† Ù…ÙˆØ¬ÙˆØ¯Ø§Ù‹
mkdir -p "$BACKUP_DIR"

# Ø¯Ø§Ù„Ø© Ù„Ù„Ù†Ø³Ø® Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠ
backup_database() {
    local DB_NAME=$1
    local DB_USER=$2
    local BACKUP_FILE="$BACKUP_DIR/${DB_NAME}_${DATE}.sql.gz"
    
    echo "ðŸ“¦ Ø¨Ø¯Ø¡ Ø§Ù„Ù†Ø³Ø® Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠ Ù„Ù‚Ø§Ø¹Ø¯Ø©: $DB_NAME"
    
    # ØªØµØ¯ÙŠØ± Ø§Ù„Ù‚Ø§Ø¹Ø¯Ø© ÙˆØ¶ØºØ·Ù‡Ø§
    mysqldump -u "$DB_USER" -p"$DB_PASS" "$DB_NAME" | gzip > "$BACKUP_FILE"
    
    if [ $? -eq 0 ]; then
        echo "âœ… ØªÙ… Ø§Ù„Ù†Ø³Ø® Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠ Ø¨Ù†Ø¬Ø§Ø­: $BACKUP_FILE"
        
        # Ø­Ø³Ø§Ø¨ Ø­Ø¬Ù… Ø§Ù„Ù…Ù„Ù
        SIZE=$(du -h "$BACKUP_FILE" | cut -f1)
        echo "ðŸ“Š Ø­Ø¬Ù… Ø§Ù„Ù…Ù„Ù: $SIZE"
        
        return 0
    else
        echo "âŒ ÙØ´Ù„ Ø§Ù„Ù†Ø³Ø® Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠ Ù„Ù‚Ø§Ø¹Ø¯Ø©: $DB_NAME"
        return 1
    fi
}

# Ø¨Ø¯Ø¡ Ø¹Ù…Ù„ÙŠØ© Ø§Ù„Ù†Ø³Ø® Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠ
echo "========================================="
echo "ðŸš€ Ø¨Ø¯Ø¡ Ø§Ù„Ù†Ø³Ø® Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠ Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ"
echo "ðŸ“… Ø§Ù„ØªØ§Ø±ÙŠØ®: $(date '+%Y-%m-%d %H:%M:%S')"
echo "========================================="
echo ""

# Ù†Ø³Ø® Ø§Ù„Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ù…Ø±ÙƒØ²ÙŠØ©
backup_database "u306850950_alabasi_main" "u306850950_alabasi1"
echo ""

# Ù†Ø³Ø® Ù‚Ø§Ø¹Ø¯Ø© ÙˆØ­Ø¯Ø© Ø§Ù„Ø­Ø¯ÙŠØ¯Ø©
backup_database "u306850950_alabasi_unit_2" "u306850950_alabasi2"
echo ""

# Ù†Ø³Ø® Ù‚Ø§Ø¹Ø¯Ø© ÙˆØ­Ø¯Ø© Ø§Ù„Ø¹Ø¨Ø§Ø³ÙŠ
backup_database "u306850950_alabasi_unit_3" "u306850950_alabasi3"
echo ""

# Ø­Ø°Ù Ø§Ù„Ù†Ø³Ø® Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠØ© Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø© (Ø£ÙƒØ«Ø± Ù…Ù† 30 ÙŠÙˆÙ…)
echo "ðŸ—‘ï¸  Ø­Ø°Ù Ø§Ù„Ù†Ø³Ø® Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠØ© Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø© (Ø£ÙƒØ«Ø± Ù…Ù† $RETENTION_DAYS ÙŠÙˆÙ…)..."
find "$BACKUP_DIR" -name "*.sql.gz" -type f -mtime +$RETENTION_DAYS -delete
echo "âœ… ØªÙ… Ø­Ø°Ù Ø§Ù„Ù†Ø³Ø® Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø©"
echo ""

# Ø¹Ø±Ø¶ Ù…Ù„Ø®Øµ Ø§Ù„Ù†Ø³Ø® Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠØ© Ø§Ù„Ù…ÙˆØ¬ÙˆØ¯Ø©
echo "========================================="
echo "ðŸ“Š Ù…Ù„Ø®Øµ Ø§Ù„Ù†Ø³Ø® Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠØ©:"
echo "========================================="
echo ""
echo "ðŸ“ Ø§Ù„Ù…Ø¬Ù„Ø¯: $BACKUP_DIR"
echo "ðŸ“¦ Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ù„ÙØ§Øª: $(ls -1 "$BACKUP_DIR"/*.sql.gz 2>/dev/null | wc -l)"
echo "ðŸ’¾ Ø§Ù„Ù…Ø³Ø§Ø­Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…Ø©: $(du -sh "$BACKUP_DIR" | cut -f1)"
echo ""

# Ø¹Ø±Ø¶ Ø¢Ø®Ø± 5 Ù†Ø³Ø® Ø§Ø­ØªÙŠØ§Ø·ÙŠØ©
echo "ðŸ“‹ Ø¢Ø®Ø± 5 Ù†Ø³Ø® Ø§Ø­ØªÙŠØ§Ø·ÙŠØ©:"
ls -lht "$BACKUP_DIR"/*.sql.gz 2>/dev/null | head -5 | awk '{print "   " $9 " (" $5 ")"}'
echo ""

echo "========================================="
echo "âœ… Ø§ÙƒØªÙ…Ù„Øª Ø¹Ù…Ù„ÙŠØ© Ø§Ù„Ù†Ø³Ø® Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠ Ø¨Ù†Ø¬Ø§Ø­"
echo "========================================="
