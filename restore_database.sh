#!/bin/bash

# ========================================
# ูุธุงู ุงุณุชุนุงุฏุฉ ุงููุณุฎ ุงูุงุญุชูุงุทูุฉ
# ููุธุงู Alabasi ุงููุญุงุณุจู
# ========================================

# ุงูุฅุนุฏุงุฏุงุช
BACKUP_DIR="/home/u306850950/backups"
DB_PASS="Alabasi@2025"

# ุงูุชุญูู ูู ุงููุนุงููุงุช
if [ $# -lt 2 ]; then
    echo "โ ุฎุทุฃ: ูุฌุจ ุชุญุฏูุฏ ุงุณู ุงููุงุนุฏุฉ ูููู ุงููุณุฎุฉ ุงูุงุญุชูุงุทูุฉ"
    echo ""
    echo "ุงูุงุณุชุฎุฏุงู:"
    echo "  $0 <database_name> <backup_file>"
    echo ""
    echo "ุฃูุซูุฉ:"
    echo "  $0 u306850950_alabasi_main u306850950_alabasi_main_20250118_120000.sql.gz"
    echo "  $0 u306850950_alabasi_unit_2 u306850950_alabasi_unit_2_20250118_120000.sql.gz"
    echo ""
    echo "๐ ุงููุณุฎ ุงูุงุญุชูุงุทูุฉ ุงููุชููุฑุฉ:"
    ls -1t "$BACKUP_DIR"/*.sql.gz 2>/dev/null | head -10
    exit 1
fi

DB_NAME=$1
BACKUP_FILE="$BACKUP_DIR/$2"
DB_USER=""

# ุชุญุฏูุฏ ุงููุณุชุฎุฏู ุจูุงุกู ุนูู ุงุณู ุงููุงุนุฏุฉ
case $DB_NAME in
    "u306850950_alabasi_main")
        DB_USER="u306850950_alabasi1"
        ;;
    "u306850950_alabasi_unit_2")
        DB_USER="u306850950_alabasi2"
        ;;
    "u306850950_alabasi_unit_3")
        DB_USER="u306850950_alabasi3"
        ;;
    *)
        echo "โ ุฎุทุฃ: ุงุณู ูุงุนุฏุฉ ุจูุงูุงุช ุบูุฑ ูุนุฑูู: $DB_NAME"
        exit 1
        ;;
esac

# ุงูุชุญูู ูู ูุฌูุฏ ููู ุงููุณุฎุฉ ุงูุงุญุชูุงุทูุฉ
if [ ! -f "$BACKUP_FILE" ]; then
    echo "โ ุฎุทุฃ: ููู ุงููุณุฎุฉ ุงูุงุญุชูุงุทูุฉ ุบูุฑ ููุฌูุฏ: $BACKUP_FILE"
    exit 1
fi

# ุชุฃููุฏ ุงูุงุณุชุนุงุฏุฉ
echo "========================================="
echo "โ๏ธ  ุชุญุฐูุฑ: ุงุณุชุนุงุฏุฉ ุงููุณุฎุฉ ุงูุงุญุชูุงุทูุฉ"
echo "========================================="
echo ""
echo "๐ฆ ุงูููู: $BACKUP_FILE"
echo "๐๏ธ  ุงููุงุนุฏุฉ: $DB_NAME"
echo "๐ค ุงููุณุชุฎุฏู: $DB_USER"
echo "๐ ุญุฌู ุงูููู: $(du -h "$BACKUP_FILE" | cut -f1)"
echo ""
echo "โ๏ธ  ุณูุชู ุญุฐู ุฌููุน ุงูุจูุงูุงุช ุงูุญุงููุฉ ูู ุงููุงุนุฏุฉ!"
echo ""
read -p "ูู ุฃูุช ูุชุฃูุฏ ูู ุงูุงุณุชุนุงุฏุฉุ (yes/no): " CONFIRM

if [ "$CONFIRM" != "yes" ]; then
    echo "โ ุชู ุฅูุบุงุก ุนูููุฉ ุงูุงุณุชุนุงุฏุฉ"
    exit 0
fi

echo ""
echo "========================================="
echo "๐ ุจุฏุก ุนูููุฉ ุงูุงุณุชุนุงุฏุฉ..."
echo "========================================="
echo ""

# ุญุฐู ุงููุงุนุฏุฉ ุงูุญุงููุฉ ูุฅุนุงุฏุฉ ุฅูุดุงุฆูุง
echo "๐๏ธ  ุญุฐู ุงููุงุนุฏุฉ ุงูุญุงููุฉ..."
mysql -u "$DB_USER" -p"$DB_PASS" -e "DROP DATABASE IF EXISTS $DB_NAME;"

echo "๐ฆ ุฅูุดุงุก ูุงุนุฏุฉ ุฌุฏูุฏุฉ..."
mysql -u "$DB_USER" -p"$DB_PASS" -e "CREATE DATABASE $DB_NAME CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;"

# ุงุณุชุนุงุฏุฉ ุงูุจูุงูุงุช
echo "๐ฅ ุงุณุชุนุงุฏุฉ ุงูุจูุงูุงุช..."
gunzip < "$BACKUP_FILE" | mysql -u "$DB_USER" -p"$DB_PASS" "$DB_NAME"

if [ $? -eq 0 ]; then
    echo ""
    echo "========================================="
    echo "โ ุชูุช ุงูุงุณุชุนุงุฏุฉ ุจูุฌุงุญ!"
    echo "========================================="
    echo ""
    echo "๐ ูุนูููุงุช ุงููุงุนุฏุฉ ุงููุณุชุนุงุฏุฉ:"
    mysql -u "$DB_USER" -p"$DB_PASS" "$DB_NAME" -e "SELECT COUNT(*) as 'ุนุฏุฏ ุงูุฌุฏุงูู' FROM information_schema.tables WHERE table_schema='$DB_NAME';"
else
    echo ""
    echo "========================================="
    echo "โ ูุดูุช ุนูููุฉ ุงูุงุณุชุนุงุฏุฉ!"
    echo "========================================="
    exit 1
fi
